# MinQ コードレビューレポート

このレポートは、現在のコードベース（特にUI/UXの実装状況、アーキテクチャ、およびアプリのコンセプト実現度）をFlutterのベストプラクティスと照らし合わせてレビューした結果です。

## 1. 総合評価 (Summary)

**評価: 🚧 発展途上 (要リファクタリング)**

プロジェクトには非常に詳細で優れた**デザインシステム (`DESIGN_SYSTEM.md`, `MinqTheme`)** と **ドメイン設計 (`lib/domain`)** が存在しますが、**実際の実装（Presentation層やData層）がそれらに追いついておらず、多くのベストプラクティス違反が見られます。**

特に、「デザインシステムが無視されている点」と「状態管理の構成（`providers.dart`の肥大化）」は、開発が進むにつれて大きな技術的負債となるリスクがあります。

---

## 2. UI/UX 実装における問題点

### ❌ デザインシステムの不使用
`lib/presentation/theme/minq_theme.dart` には素晴らしいデザイントークン（色、スペース、タイポグラフィ）が定義されていますが、実際の画面コード（例: `home_screen_v2.dart`）ではこれらがほとんど使われていません。

*   **現状:**
    ```dart
    // home_screen_v2.dart
    Text("12日", style: TextStyle(fontSize: 20, fontWeight: FontWeight.bold))
    Icon(Icons.check_circle_outline, color: Colors.green)
    SizedBox(height: 16)
    ```
*   **あるべき姿:**
    ```dart
    // デザインシステムを利用する
    Text("12日", style: context.tokens.titleMedium)
    Icon(Icons.check_circle_outline, color: context.tokens.accentSuccess)
    SizedBox(height: context.tokens.spaceLG)
    ```
*   **影響:** アプリ全体でデザインの一貫性が損なわれ、ダークモード対応やサイズ変更への対応が困難になります。

### ❌ 文字列のハードコーディング (i18nの無視)
`lib/l10n` に多言語化のファイル (`.arb`) が用意されていますが、UIコード内では日本語の文字列が直接書き込まれています。

*   **現状:** `const Text("今日のクエスト")`
*   **あるべき姿:** `Text(AppLocalizations.of(context)!.todaysQuests)`
*   **影響:** 将来的な多言語対応が困難になるだけでなく、文言の変更修正がコード修正を伴うため非効率です。

### ❌ プレースホルダーだらけのUX
多くのウィジェットが「見た目だけ」のハリボテ状態であり、実際のユーザー体験（UX）に不可欠な以下の要素が欠落しています。

*   **ローディング状態:** データ取得中のインジケータがない。
*   **エラー状態:** オフライン時やエラー時の表示がない。
*   **空の状態 (Empty State):** クエストがない時の表示がない。
*   **インタラクション:** ボタンを押しても反応しない（`TODO` コメントのみ）箇所が多数。

---

## 3. アーキテクチャとロジックの問題点

### ❌ `providers.dart` の肥大化 (God File)
`lib/data/providers.dart` にアプリ内のほぼすべてのProviderが記述されています（約400行）。

*   **問題点:** Riverpodのメリットである「機能ごとのモジュール性」が失われています。ファイルが巨大すぎて、どの機能がどのデータに依存しているかが見通せません。
*   **改善案:** `features/home/providers.dart` や `features/quest/providers.dart` のように、機能（Feature）ごとにProviderを分割して配置すべきです。

### ❌ アプリケーション層 (Application Layer) の欠如
現在の構成は `UI` -> `Repository` -> `Data Source` となっていますが、複雑なビジネスロジックを処理する「アプリケーション層（またはController/Service層）」が不足しています。

*   **具体例:** 「クエストを完了する」というアクションは、単にDBを更新するだけでなく、「経験値の計算」「バッジの判定」「ペアへの通知」「統計の更新」など複数の処理を連鎖させる必要があります。
*   **現状:** これらを制御する場所がなく、UI (`onPressed`) に書くか、Repositoryに詰め込むことになりそうです。
*   **リスク:** ロジックが分散し、整合性が保てなくなります。

### ❌ データソースの不整合 (Isar vs Firebase)
*   **クエストデータ:** ローカルDB (`Isar`)
*   **ゲーミフィケーション/ペア:** クラウドDB (`Firebase Firestore`)

これらが混在していますが、明確な同期戦略が見えません。
例えば、オフラインでクエストを完了した場合、`Isar`は更新されますが、`GamificationEngine`（Firestoreに直接書き込む実装になっている）はどう動くのでしょうか？
`FirestoreSyncService` はありますが、これは単にログをアップロードするだけで、ユーザーへの即時フィードバック（ポイント獲得演出など）とどう連携するかが不明確です。

### ❌ リポジトリの肥大化
`QuestRepository` 内に `_templateSeedData` として大量の初期データがハードコーディングされています。これはデータ層の責務ではなく、設定ファイルや別のアセットとして管理すべきです。

---

## 4. コンセプト実現度に関する懸念

### ⚠️ 「習慣化」のループが未実装
アプリの核となる「3タップ習慣化」「即時報酬」のロジックがまだ `TODO` のままです。
UI上でチェックをつけても、裏側でポイントが計算され、褒められる（Reward）までの繋がりが実装されていません。今のままでは単なる「チェックリスト」であり、MinQの目指す「楽しく続く習慣化アプリ」体験は提供できません。

### ⚠️ ペア機能の遅れ
ペア機能 (`features/pair`) はフォルダ構造こそありますが、中身がほぼ空です。「逆アカウンタビリティ（誰かと一緒だから頑張れる）」はこのアプリの重要な差別化要因ですが、実装の優先度が低くなっているように見受けられます。

---

## 5. 改善のための推奨アクション (Next Steps)

1.  **UIのリファクタリング:**
    *   `home_screen_v2.dart` を書き直し、`MinqTheme` (context.tokens) を徹底的に使用する。
    *   文字列を全て `.arb` ファイルに抽出する。

2.  **アーキテクチャの再整理:**
    *   `providers.dart` を解体し、各Featureディレクトリに移動する。
    *   **Controller / Notifier** を導入し、「クエスト完了」などの複雑なフローを管理するクラスを作成する。

3.  **コアロジックの実装:**
    *   `GamificationEngine` が `Isar` の変更（クエスト完了）を検知して動くように、ローカルファーストな設計に変更する（まずはローカルでポイント加算し、後でSyncするなど）。

4.  **シードデータの分離:**
    *   `_templateSeedData` を `assets/data/initial_quests.json` などに移動し、読み込むように変更する。

このレビューがプロジェクトの品質向上に役立つことを願っています。
