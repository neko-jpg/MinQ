# MinQアプリ 問題点調査レポート

## 調査日時
2025年10月18日

## 概要
実装されているのに動いていない機能や、配線が整っていない部分を調査しました。

---

## 🔴 重大な問題

### 1. flutter_gemma（AI機能）が全く使われていない

**問題点:**
- `GemmaAIService`は実装されているが、実際には**どこでも使用されていない**
- クエスト画面の「AIおすすめ」は`HabitAiSuggestionService`を使用（ルールベースのロジック）
- サポート画面は「GPT-4o サポートチャット」と表示されているが、実際は`SupportChatService`を使用
- ホーム画面のAIコンシェルジュ機能も未実装

**影響範囲:**
- クエスト画面の「AIおすすめ」 → Gemmaを使っていない
- サポート画面のチャット → Gemmaを使っていない  
- ホーム画面のAI機能 → 実装されていない

**修正が必要な箇所:**
```
lib/presentation/screens/quests_screen.dart (AIおすすめ機能)
lib/presentation/screens/support_screen.dart (サポートチャット)
lib/presentation/screens/home_screen.dart (AIコンシェルジュ)
lib/domain/recommendation/habit_ai_suggestion_service.dart (Gemma統合)
lib/data/services/support_chat_service.dart (Gemma統合)
```

---

### 2. クエスト作成後の画面遷移が不完全

**問題点:**
- `CreateQuestScreen`でクエストを作成後、`context.pop()`で前の画面に戻るだけ
- 作成したクエストの詳細画面や、クエスト開始画面に遷移しない
- ユーザーは作成したクエストをすぐに使えない

**現在の実装:**
```dart
// lib/presentation/screens/create_quest_screen.dart:238付近
await ref.read(questRepositoryProvider).addQuest(newQuest);
// ...
if (mounted) {
  FeedbackMessenger.showSuccessToast(context, '新しい習慣を作成しました！');
  context.pop(); // ← ここで前の画面に戻るだけ
}
```

**期待される動作:**
- クエスト作成後 → クエスト詳細画面に遷移
- または → 「クエストを開始する」画面に遷移

**修正が必要な箇所:**
```
lib/presentation/screens/create_quest_screen.dart (_saveQuest メソッド)
```

---

### 3. ペア画面が「ペアを探しています」で止まる

**問題点:**
- `PairMatchingScreen`の実装が不完全
- `_executePairingLogic()`でモックデータを返している
- 実際のマッチング処理が実装されていない

**現在の実装:**
```dart
// lib/presentation/screens/pair/pair_matching_screen.dart:67付近
if (widget.code != null) {
  // pairId = await repo.joinPairWithCode(uid, widget.code!);
  pairId = 'mock_pair_id_from_code'; // ← モックデータ
} else {
  const category = 'Fitness';
  pairId = await repo.requestRandomPair(uid, category);
}
```

**修正が必要な箇所:**
```
lib/presentation/screens/pair/pair_matching_screen.dart
lib/data/repositories/pair_repository.dart (マッチングロジック)
```

---

## 🟡 中程度の問題

### 4. 設定画面にモックデータが混在

**問題点:**
- サポートチャットが「GPT-4o」と表示されているが実際は違う
- 一部の設定項目が実際の機能と連携していない

**修正が必要な箇所:**
```
lib/presentation/screens/settings_screen.dart (サポートセクション)
lib/presentation/screens/support_screen.dart (表示テキスト)
```

---

### 5. クエスト詳細画面の「クエストを記録する」ボタン

**問題点:**
- nexttask.mdによると、「クエストを開始する」ボタンに変更し、タイマー/ストップウォッチ画面に遷移する必要がある
- 現在は単純な記録画面に遷移するだけ

**修正が必要な箇所:**
```
lib/presentation/screens/quest_detail_screen.dart
lib/presentation/screens/record_screen.dart (タイマー/ストップウォッチ機能追加)
```

---

## 📋 配線が整っていない機能リスト

### AI関連
1. ❌ **ホーム画面のAIコンシェルジュ** → 未実装
2. ❌ **クエスト画面のAIおすすめ** → Gemmaを使っていない（ルールベースのみ）
3. ❌ **サポート画面のAIチャット** → Gemmaを使っていない

### ペア機能
4. ❌ **ペアマッチング** → モックデータで止まっている
5. ❌ **ペア画面の実際の機能** → マッチング後の画面遷移が不完全

### クエスト機能
6. ⚠️ **クエスト作成後の遷移** → 前の画面に戻るだけ
7. ⚠️ **クエスト開始ボタン** → タイマー/ストップウォッチ機能が未実装

### 設定画面
8. ⚠️ **サポートチャットの表示** → 「GPT-4o」と表示されているが実際は違う

---

## 🔧 推奨される修正順序

### 優先度: 高
1. **Gemma AIの統合** - 最も重要な機能が動いていない
   - `HabitAiSuggestionService`にGemma統合
   - `SupportChatService`にGemma統合
   - ホーム画面にAIコンシェルジュ追加

2. **クエスト作成後の遷移修正**
   - 作成後にクエスト詳細画面に遷移
   - または「クエストを開始する」画面に遷移

3. **ペアマッチング機能の完成**
   - モックデータを削除
   - 実際のマッチングロジック実装

### 優先度: 中
4. **クエスト開始ボタンとタイマー機能**
   - タイマー/ストップウォッチ画面の実装
   - 横スワイプでの切り替え機能

5. **設定画面の表示修正**
   - サポートチャットの正確な表示

---

## 📝 技術的な詳細

### Gemma統合の実装方法

現在、`GemmaAIService`は実装されているが使われていません：

```dart
// lib/core/ai/gemma_ai_service.dart
final gemmaAIServiceProvider = Provider<GemmaAIService>((ref) {
  return GemmaAIService();
});
```

**統合が必要な箇所:**

1. **AIおすすめ機能** (`lib/domain/recommendation/habit_ai_suggestion_service.dart`)
   - 現在: ルールベースのロジックのみ
   - 修正: Gemmaを使ってパーソナライズされた提案を生成

2. **サポートチャット** (`lib/data/services/support_chat_service.dart`)
   - 現在: 未実装または別のサービス使用
   - 修正: Gemmaを使ってユーザーの質問に回答

3. **ホーム画面** (`lib/presentation/screens/home_screen.dart`)
   - 現在: AIコンシェルジュ機能なし
   - 修正: Gemmaを使って励ましメッセージや提案を表示

---

## まとめ

**主な問題:**
- ✅ 実装されている: `GemmaAIService`, マッチング画面, クエスト作成
- ❌ 配線されていない: AI機能が全く使われていない
- ❌ 不完全: ペアマッチングがモックデータで止まる
- ❌ 遷移不足: クエスト作成後の画面遷移がない

**影響:**
ユーザーは以下の機能を使えません：
1. AIによるクエスト提案（実装されているが動いていない）
2. AIサポートチャット（実装されているが動いていない）
3. ペアマッチング（モックで止まる）
4. クエスト作成後のスムーズな開始（遷移がない）

これらの問題を修正することで、アプリは設計通りに動作するようになります。
