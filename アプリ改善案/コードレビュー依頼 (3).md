厳格改善要求レポート for  lib/data/services/

isar_service.dart

セクションA：厳格改善要求レポート (技術監査)

1. UI（ユーザーインターフェース）改善レポート

このファイルはデータベースサービスの初期化を担当しており、UI要素を含みません。そのためUIに関する

指摘はありません。

2. UX（ユーザーエクスペリエンス）改善レポート

IsarServiceはアプリのローカルデータベース（Isar）を初期化する役割を持ち、UXの間接的な影響がありま

す。

•

問題点 [UXF-004]: データベース初期化時に kIsWeb でWeb環境を判定し null ディレクトリを指定し

ているが、初期化の進行状況がUIに通知されない。

•

重大度: 低

•

最悪のシナリオ: 初回起動時にデータベースが開くまで数秒掛かる場合、ユーザーがアプリが固まって

いると誤解する。

•

具体的改善案: init() 関数の呼び出し側でローディング表示を行えるよう、初期化進行状況を返却す

るか Future 完了をUIでハンドリングする。Isarの開閉処理は try-catch でラップし、エラー時に

ユーザーへ適切に伝える。

3. パフォーマンス改善レポート (ボトルネック特定)

•

問題点 [PERF-005]: Isar.open() でスキーマのリストを動的に生成しているが、生成しているスキー
マの順序や重複が固定ではないためバイナリサイズや初期化時間が増加する可能性がある。

•

重大度: 低

•

場所: 1"> isar_service.dart  20–28行目

•

最悪のシナリオ: スキーマの数が増加した際に不要なスキーマを含めてしまい、モバイル端末のスト

レージを圧迫する。

•

具体的改善案:  使用していないエンティティのスキーマをリストから削除し、必要最小限にする。ス

キーマ定義を別ファイルで管理し、機能開発に応じて動的に追加できるようにする。

•

問題点   [PERF-006]:

Isar.getInstance() で既存インスタンスを取得しているが、アプリ終了時の

isar.close() 処理が無いためインスタンスリークの可能性がある。

•

重大度: 中

•

場所: 全体

•

最悪のシナリオ: アプリの再起動やホットリロード時に複数のIsarインスタンスが残り、データベース

ロックが発生する。

•

具体的改善案: アプリ終了時または必要に応じて isar.close() を必ず呼び出すよう、サービスに

dispose() メソッドを追加し、アプリライフサイクルで呼び出す。 WidgetsBindingObserver 等でラ

イフサイクルイベントをフックする。

1

4. アーキテクチャ・コード品質改善レポート

•

問題点 [CODE-006]: コメントで「Pair is Firestore-only for now」と記載されているが、将来的にIsar

でも保存できるようにする計画がコード上に反映されていない。

•

重大度: 低

•

場所: 2"> isar_service.dart  3–4行目

•

最悪のシナリオ: Firestore専用でデータ設計しているためローカル保存への移行に手間がかかる。

•

具体的改善案: Domain層のエンティティが永続層に依存しないようリポジトリパターンを導入し、

IsarとFirestoreを統一インターフェースで扱えるようにする。必要なスキーマは状況に応じて追加可

能なように整備する。

5. セキュリティ脆弱性レポート

現状、IsarService内にユーザー入力や外部リソースを扱う箇所はなく、OWASP   Mobile   Top   10の観点で重大

な脆弱性は見られません。ディレクトリパスの取り扱いに関して path_provider から取得しているため安全

です。

6. 国際化 (i18n) 対応準備レポート

このファイルには表示文字列がないためi18nの対象外です。

セクションB：生成タスク (QA・ドキュメント)

7. 優先度付き改善タスクリスト（バックログ形式）

優先度

指摘ID

タスク概要

推定工数

（人日）

担当推奨

P1 (今週

中)

P2 (次ス

プリン

ト)

P3 (将来

的)

P3 (将来

的)

[PERF-006]

isar.close() を呼び出す dispose() メソッド

を追加し、アプリライフサイクルに組み込む

1.0

Backend

[PERF-005]

使用していないスキーマの削除とスキーマ管理

の整理

0.5

Backend

[CODE-006]

リポジトリパターンの導入によりIsarと

Firestoreの実装を抽象化

[UXF-004]

データベース初期化の進捗通知を提供し、UI側

でローディングを表示

2.0

0.5

Backend,

Arch

App

8. 不足ドキュメント（README.md 追記案）

IsarService の利用方法をREADMEに追加し、ローカルデータベースの初期化・使用に関するガイドライン

を明示することが推奨されます。

## 🗂 Isarローカルデータベース利用ガイド

### 初期化

2

* `lib/data/services/isar_service.dart` に定義される `IsarService` を利用してデータベースを初期

化します。アプリ起動時に `await IsarService().init()` を実行し、戻り値として取得した `Isar` イン

スタンスをリポジトリ層へ渡してください。

### クローズ処理

* アプリ終了時や不要になった際は、`IsarService.isar.close()` を呼び出してデータベースインスタ

ンスを解放してください。`WidgetsBindingObserver` を実装し、`AppLifecycleState.detached` で呼

び出すと安全です。

### スキーマ管理

* 使用するドメインモデルのスキーマのみを `schemas` リストに登録し、不要なスキーマは削除して

ください。スキーマ追加時は`flutter pub run build_runner build`で生成コードを更新する必要があ

ります。

### バックアップ・リストア

* 将来的にIsarデータベースのバックアップ機能を提供する場合は、`Isar.copyToFile()`や外部スト

レージへのエクスポート機能の実装を検討してください。ユーザーデータ保全の観点で説明を追記する

ことが望ましいです。

1

2

isar_service.dart

https://github.com/neko-jpg/MinQ/blob/feat-improve/lib/data/services/isar_service.dart

3

