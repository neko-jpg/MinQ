厳格改善要求レポート for  lib/core/ai/

ai_coach_controller.dart

セクションA：厳格改善要求レポート (技術監査)

1. UI（ユーザーインターフェース）改善レポート

このファイルは状態管理とAIサービス呼び出しを担うクラスであり直接UIを扱いません。ただし、データ構

造とUI連携の設計がユーザーインターフェースに影響を与えるため、以下の点を指摘します。

•

問題点 [UI-005]: sendMessage 内で会話履歴を組み立てる際、 conversationHistory を文字列連結で

UIに直接渡している。フォーマットやローカライズが考慮されておらず、UI側での表現に制約を与え

ている。

•

重大度: 中

•

場所: 1"> ai_coach_controller.dart  76–80行目

•

最悪のシナリオ: UI層で会話履歴を表示する際に改行やマークアップが適切に行えず、読みづらい

チャットUIとなる。
具体的改善案: ChatMessage のリストをそのままUIに渡し、表示形式はUI層で定義する。AIサービス

•

への入力用履歴は別途 List<Map<String,String>> にマッピングするなど、責務を分離する。

2. UX（ユーザーエクスペリエンス）改善レポート

•

問題点 [UXF-005]: userId が空文字列のまま初期化されており、どのユーザーの会話履歴か判別でき

ない。

•

重大度: 高

•

場所: 2"> ai_coach_controller.dart  24–30行目

•

最悪のシナリオ: 複数ユーザーが同端末を利用する場合に会話履歴が混在し、プライバシー侵害や

パーソナライズの失敗につながる。

•

具体的改善案:  ユーザー認証後に AICoachState へ正しい userId を設定するようリポジトリから受け

取る。Riverpodの ScopedProvider を用いて認証情報を注入し、AIコーチ状態の初期化時にユーザID

を設定する。

•

問題点 [UXF-006]:  生成するAIの返信が固定長（150トークン）であり、ユーザーの入力文に関わらず

同一長の返信が返される可能性がある。

•

重大度: 中

•

最悪のシナリオ: 長文質問に対し回答が途中で途切れたり、短い質問に対して冗長な返答が返る。

ユーザー満足度が低下する。

•

具体的改善案: メッセージの長さや内容に応じて maxTokens を動的に調整する。また、モデル側で適

切な停止条件（ストップシーケンス）を設定し、適度な長さの返信を生成する。 systemPrompt や

temperature などAI生成パラメータを設定として外部化し、UXチームがチューニングできるようにす

る。

1

3. パフォーマンス改善レポート (ボトルネック特定)

•

問題点 [PERF-007]: 各 sendMessage 呼び出しで _tfliteService.initialize() を実行しており、既

に初期化済みでも毎回非同期処理を待つ可能性がある。

•

重大度: 中

•

場所: 3"> ai_coach_controller.dart  48–52行目

•

最悪のシナリオ: メッセージ送信の都度初期化処理が重複し、応答遅延が発生する。

•

具体的改善案: AIサービス内で初期化状況をキャッシュし、一度初期化されたら処理をスキップする。

また、 sendMessage 内では await で待機せず、初期化中はローディング状態をUIに通知し、初期化

完了後にAI生成を開始するように設計する。

4. アーキテクチャ・コード品質改善レポート

•

問題点 [CODE-007]: sendMessage メソッドがUIの状態更新、AIサービスの呼び出し、エラー処理な

ど複数の責務を抱えており、単一責務原則 (SRP) に反している。

•

重大度: 高

•

場所: 4"> ai_coach_controller.dart  32–74行目

•

最悪のシナリオ: 新機能追加やバグ修正時にメソッドが肥大化し、不具合が起こりやすくなる。テス

トが困難になる。

•

具体的改善案:

sendMessage 内の処理を複数のプライベートメソッドに分割（メッセージ履歴更新、

AI呼び出し、エラー処理）する。また、AIサービスを呼び出すためのリポジトリクラスを導入し、状

態管理クラスはUIへの状態配信に専念させる。

•

問題点   [CODE-008]: systemPrompt と _coachUnavailableMessage がコード内にハードコードされて

いる。

•

重大度: 中

•

場所: 5"> ai_coach_controller.dart  84–90行目

•

最悪のシナリオ: メッセージの内容変更や多言語展開時にソースを直接修正する必要があり、変更漏れ

のリスクが高い。

•

具体的改善案: これらの文言を外部の設定ファイルやリソースファイルに移動し、 AppLocalizations

やリモートコンフィグで取得する。管理者が翻訳・チューニングしやすいようにKey-Value構造で管

理する。

5. セキュリティ脆弱性レポート

•

問題点 [SEC-005]: ユーザメッセージの送信時に _buildHistory で過去メッセージを平文で連結して

いるが、会話履歴に個人情報が含まれる可能性がある。万が一ログ出力やエラーレポートに履歴が含
まれると情報漏洩となる。

•

重大度: 中

•

場所: 1"> ai_coach_controller.dart  76–80行目

•

最悪のシナリオ: クラッシュログや診断情報に個人の会話内容が記録され、プライバシー侵害が発生

する。

•

具体的改善案: 履歴をAIサービスに送る際には必要最小限の文脈のみ渡し、個人情報をフィルタリング

する。ログ出力時には匿名化やマスキングを行う。GDPR/日本の個人情報保護法に沿って、ユーザー

データを適切に扱う。

6. 国際化 (i18n) 対応準備レポート

•

問題点 [I18N-002]: システムプロンプトとエラーメッセージが日本語の固定文として記述されてい

る。

2

•

重大度: 高

•

場所: 5"> ai_coach_controller.dart  84–90行目

•

最悪のシナリオ: グローバル展開時にプロンプトやメッセージの翻訳が漏れ、AIが日本語で返答してし

まう。

•

具体的改善案: プロンプトとエラーメッセージを .arb ファイルに移し、各言語に対して適切なメッ

セージを準備する。 generateChatResponse に渡すシステムプロンプトもローカライズされたものを

使用する。

セクションB：生成タスク (QA・ドキュメント)

7. 優先度付き改善タスクリスト（バックログ形式）

優先度

指摘ID

タスク概要

推定工数

（人日）

[UXF-005]

認証処理と連携し、AICoachStateの userId

を正しく設定する

[I18N-002]

systemPrompt およびエラーメッセージ

を .arb ファイルに移行する

[CODE-007]

[PERF-007]

[SEC-005]

sendMessage を単一責務に分割し、リポジ

トリ層を導入する

AIサービスの初期化をキャッシュし、冗長な

初期化呼び出しを削減

会話履歴から個人情報をフィルタリングし、

ログ出力をマスキングする

1.0

0.5

2.0

1.0

1.0

担当推奨

Backend,

App

App (i18n)

Backend,

Arch

Backend

Backend,

Security

[UI-005]

履歴表示フォーマットをUI層に移譲し、

ChatMessage のリストを直接UIに渡す

1.0

App

[UXF-006]

maxTokens や停止条件を動的設定できる仕

組みを導入し、UXチューニングを行う

1.5

Backend, AI

P0 (即時

対応)

P0 (即時

対応)

P1 (今週

中)

P1 (今週

中)

P1 (今週

中)

P2 (次ス

プリン

ト)

P2 (次ス

プリン

ト)

8. 不足ドキュメント（README.md 追記案）

AIコーチコントローラの動作や設定に関するドキュメントが不足しているため、以下をREADMEに追記するこ

とを推奨します。

##

 AIコーチ機能の実装ガイド

### 状態管理

* AIコーチ機能は`AICoachController`（Riverpodの`StateNotifier`）によって管理されます。ユー

ザー認証後に`userId`を状態に設定してください。

* 会話履歴は`ChatMessage`のリストとして保持し、UIはこのリストを監視してチャットUIを構築しま

す。

3

### メッセージ送信フロー

1. ユーザーがテキストを入力すると`sendMessage`が呼び出されます。`sendMessage`内では履歴にメッ

セージを追加し、AIサービスへリクエストを送信します。

2. AIサービス（`TFLiteUnifiedAIService`など）が初期化されていない場合は初期化を行います。初期

化中はUI側でローディングを表示してください。

3. 応答が返ってきたら履歴に追加し、`isTyping`を`false`に更新します。

### カスタマイズとローカライズ

* コーチのシステムプロンプトやエラーメッセージは`lib/l10n/intl_*.arb`に定義し、各言語で翻訳を

追加します。

* `maxTokens`やその他のAIパラメータはアプリ設定やリモートコンフィグから変更できるように設計

し、UXチームが調整できるようにします。

### プライバシーへの配慮

* 会話履歴には個人情報が含まれる可能性があるため、AIサービスへ送信する際にはマスキングや匿名

化を行ってください。

* クラッシュレポートやログに会話履歴を出力しないよう、`logger`の設定やフィルタを適切に実装し

てください。

1

2

3

4

5

ai_coach_controller.dart

https://github.com/neko-jpg/MinQ/blob/feat-improve/lib/core/ai/ai_coach_controller.dart

4

